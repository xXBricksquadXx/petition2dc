<section class="mb-3">
  <div class="d-flex flex-wrap align-items-center gap-2">
    <h1 class="h4 mb-0"><%= petition.title %></h1>
    <span class="badge text-bg-info"><%= petition.issue_label %></span>
    <span class="badge status-badge status-<%= petition.status %>"><%= petition.status %></span>
  </div>
  <div class="text-muted small mt-1">
    <strong><%= petition.signature_count %></strong> signatures â€¢ Created <%= new Date(petition.created_at).toLocaleString() %>
  </div>

  <div class="mt-2">
    <a class="btn btn-sm btn-outline-secondary" href="/p/<%= petition.slug %>">View public page</a>
    <a class="btn btn-sm btn-outline-secondary ms-1" href="/admin">Back</a>
  </div>
</section>

<div class="row g-3">
  <div class="col-12 col-lg-6">
    <div class="card">
      <div class="card-body">
        <h2 class="h6">Petition status</h2>
        <form method="post" action="/admin/p/<%= petition.id %>/status" class="d-flex gap-2 align-items-end">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <div class="flex-grow-1">
            <label class="form-label small">Status</label>
            <select class="form-select form-select-sm" name="status">
              <% ["RECEIVED","IN_REVIEW","DELIVERED","RESPONDED","CLOSED"].forEach((s) => { %>
                <option value="<%= s %>" <%= petition.status === s ? 'selected' : '' %>><%= s %></option>
              <% }) %>
            </select>
          </div>
          <button class="btn btn-sm btn-primary" type="submit">Update</button>
        </form>

        <hr class="my-3" />

        <h2 class="h6">Delivery rows</h2>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Target</th>
                <th>Status</th>
                <th>Note</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% deliveries.forEach((d) => { %>
                <tr>
                  <td><%= d.target.replace('_',' ') %></td>
                  <td><span class="badge text-bg-secondary"><%= d.status %></span></td>
                  <td class="text-muted"><%= d.note || "" %></td>
                  <td class="text-end">
                    <button
                      class="btn btn-sm btn-outline-primary"
                      type="button"
                      data-bs-toggle="modal"
                      data-bs-target="#deliveryModal"
                      data-delivery-id="<%= d.id %>"
                      data-delivery-target="<%= d.target %>"
                      data-delivery-status="<%= d.status %>"
                      data-delivery-note="<%= d.note || '' %>"
                    >Edit</button>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>

        <div class="modal fade" id="deliveryModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <form method="post" action="/admin/delivery/ID_REPLACE" id="deliveryForm">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                <div class="modal-header">
                  <h5 class="modal-title">Update delivery</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-2 text-muted small" id="deliveryTargetLabel"></div>

                  <label class="form-label">Status</label>
                  <select class="form-select" name="status" id="deliveryStatus">
                    <% ["QUEUED","SENT","FAILED","ACKNOWLEDGED"].forEach((s) => { %>
                      <option value="<%= s %>"><%= s %></option>
                    <% }) %>
                  </select>

                  <label class="form-label mt-3">Note (optional)</label>
                  <textarea class="form-control" name="note" id="deliveryNote" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary">Save</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <script>
          (function () {
            const modal = document.getElementById("deliveryModal");
            const form = document.getElementById("deliveryForm");
            const statusSel = document.getElementById("deliveryStatus");
            const note = document.getElementById("deliveryNote");
            const label = document.getElementById("deliveryTargetLabel");

            modal.addEventListener("show.bs.modal", function (event) {
              const button = event.relatedTarget;
              const id = button.getAttribute("data-delivery-id");
              const target = button.getAttribute("data-delivery-target");
              const status = button.getAttribute("data-delivery-status");
              const existingNote = button.getAttribute("data-delivery-note") || "";

              form.action = "/admin/delivery/" + id;
              statusSel.value = status;
              note.value = existingNote;
              label.textContent = "Target: " + target.replace("_"," ");
            });
          })();
        </script>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card">
      <div class="card-body">
        <h2 class="h6">Petition manager</h2>
        <div class="small">
          <div><strong>Name:</strong> <%= petition.manager_first %> <%= petition.manager_last %></div>
          <div><strong>Email:</strong> <%= petition.manager_email %></div>
        </div>

        <hr class="my-3" />

        <h2 class="h6">Text</h2>
        <pre class="petition-body"><%= petition.body %></pre>
      </div>
    </div>
  </div>
</div>
